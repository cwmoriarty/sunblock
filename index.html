<!DOCTYPE html>
<html>

<body>
  <h1><span id="city"></span> Weather</h1>
  Currently <span id="temp"></span> and <b><span id="shortForecast"></span></b><br>
  <img id="weather_icon" src="">
  <br><Br>
  <b>Zipcode:</b> <span id="zip"></span><br>
  <b>Lat, Lon:</b> <span id="latlon"></span>



  <script type="text/javascript">
    
    //Get client Lat/Lon 
    fetch('https://ipapi.co/json') //ssl-tax free version of http://ip-api.com/json/
      .then(response => response.json())
      .then(data => {
        document.getElementById("zip").innerHTML = data.postal;
        document.getElementById("city").innerHTML = data.city;
        document.getElementById("latlon").innerHTML = data.latitude + "," + data.longitude;
        weatherAPIURL = 'https://api.weather.gov/points/' + data.latitude + "," + data.longitude;


        //Get Local Weather Station forecastURL
        //todo, make this syncronous after the above fetch completes, not whithin
        fetch(weatherAPIURL, {
          method: 'GET',
          headers: { 'User-Agent': '(cwmoriarty.github.io/sunblock, cwm@cwmoriarty.com)', }
        })
          .then(response => response.json())
          .then(data => {
            localforecastURL = `${data.properties.forecastHourly}` //?units=si for celcius



            //Get Forecast (Hourly)
            fetch(localforecastURL, {
              method: 'GET',
              headers: { 'User-Agent': '(cwmoriarty.github.io/sunblock, cwm@cwmoriarty.com)', }
            })
              .then(response => response.json())
              .then(data => {
                console.log(data);
                shortForecast = data.properties.periods[0].shortForecast;
                temp = data.properties.periods[0].temperature + '' + data.properties.periods[0].temperatureUnit;

                icon = data.properties.periods[0].icon; //todo sanitize URL (has a trailing ',0?small')

                document.getElementById("shortForecast").innerHTML = shortForecast;
                document.getElementById("temp").innerHTML = temp;

                //document.getElementById("weather_icon").src = icon;

              })
              .catch(error => {
                console.error("Error fetching Forecast data:", error);
              });
          })
          .catch(error => {
            console.error("Error fetching Weather Station data:", error);
          });
      })
      .catch(error => {
        console.error("Error fetching IP data:", error);
      });
  </script>
</body>

</html>
